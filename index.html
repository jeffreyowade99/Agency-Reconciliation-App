<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bellarosa Enterprises - Agency Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@500;700&display=swap');
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .font-mono { font-family: 'JetBrains+Mono', monospace; }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .brand-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        
        #authGateway { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); opacity: 1; visibility: visible; z-index: 100; }
        #authGateway.hidden-gateway { opacity: 0; visibility: hidden; pointer-events: none; transform: scale(1.05); }
        
        #confirmModal { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden-overlay { opacity: 0; visibility: hidden; pointer-events: none; transform: scale(1.02); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- Auth Gateway -->
    <div id="authGateway" class="fixed inset-0 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-md">
        <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8 animate-in border border-slate-100">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-rose-50 rounded-2xl mb-4">
                    <i data-lucide="shield-check" class="text-rose-600 w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-900">Agency Portal</h2>
                <p class="text-slate-500 text-sm mt-1">Enter staff name to access Trinity PS</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase ml-1">Staff Member</label>
                    <input id="staffNameInput" type="text" placeholder="Your Name" 
                        class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-rose-500 outline-none transition-all font-semibold" />
                </div>
                <button onclick="window.handleLogin()" class="w-full brand-gradient text-white py-4 rounded-2xl font-bold text-lg shadow-lg hover:brightness-125 transition-all">
                    Access Dashboard
                </button>
            </div>
        </div>
    </div>

    <!-- Transaction Confirmation Modal -->
    <div id="confirmModal" class="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/80 backdrop-blur-sm hidden-overlay">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl p-8 border border-white/20">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-14 h-14 bg-amber-50 rounded-full mb-4">
                    <i data-lucide="help-circle" class="text-amber-600 w-7 h-7"></i>
                </div>
                <h3 class="text-xl font-black text-slate-900">Confirm Entry?</h3>
                <p class="text-slate-500 text-sm mt-1">Please verify the details below</p>
            </div>

            <div class="bg-slate-50 rounded-2xl p-5 mb-6 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Agency</span>
                    <span id="confirmAgency" class="text-sm font-bold text-slate-900">...</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Action</span>
                    <span id="confirmType" class="text-xs font-black px-2 py-0.5 rounded bg-slate-200">...</span>
                </div>
                <div class="pt-3 border-t border-slate-200 flex justify-between items-center">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Total Amount</span>
                    <span id="confirmAmount" class="text-lg font-mono font-black text-rose-600">0.00</span>
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="window.commitTransaction()" class="w-full brand-gradient text-white py-4 rounded-2xl font-bold shadow-lg hover:brightness-110 active:scale-95 transition-all">
                    Confirm & Record
                </button>
                <button onclick="window.closeConfirmModal()" class="w-full py-3 text-slate-400 font-bold text-sm hover:text-slate-600 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="max-w-5xl mx-auto p-4 md:p-8 opacity-0 transition-opacity duration-700">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-rose-600 text-white text-[10px] font-black px-2 py-0.5 rounded tracking-tighter">BE</span>
                    <h1 class="text-2xl font-black text-slate-900 tracking-tight uppercase">Bellarosa Enterprises</h1>
                </div>
                <p class="text-slate-500 font-semibold text-xs flex items-center gap-2">
                    <span class="text-rose-600">Trinity PS</span> 
                    <span class="text-slate-300">•</span>
                    User: <span id="currentStaffDisplay" class="text-slate-900 font-bold underline decoration-rose-500">...</span>
                </p>
            </div>
            
            <div class="brand-gradient text-white px-6 py-4 rounded-2xl shadow-xl flex items-center gap-4 border-t-4 border-rose-500 min-w-[280px]">
                <i data-lucide="landmark" class="text-rose-400 w-8 h-8"></i>
                <div>
                    <p class="text-[10px] uppercase tracking-widest text-slate-400 font-bold">Pooled Cash (KES)</p>
                    <p id="totalCashDisplay" class="text-2xl font-mono font-bold leading-none">0.00</p>
                </div>
            </div>
        </header>

        <div id="floatGrid" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-8"></div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-5">
                <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden sticky top-8">
                    <div class="p-6 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                        <h2 class="text-lg font-bold flex items-center gap-2 text-slate-800">
                            <i data-lucide="list-plus" class="text-rose-500 w-5 h-5"></i> Log Entry
                        </h2>
                        <div id="syncIndicator" class="flex items-center gap-1.5 px-2 py-1 rounded bg-slate-100 text-slate-400 text-[10px] font-bold">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i> INITIALIZING
                        </div>
                    </div>

                    <div class="p-6 space-y-5">
                        <div id="messageBox" class="hidden p-4 rounded-xl text-sm font-bold animate-in"></div>

                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Agency</label>
                            <select id="agencySelect" class="w-full p-3.5 bg-slate-50 border-2 border-slate-100 rounded-xl focus:border-rose-500 outline-none font-semibold appearance-none cursor-pointer">
                                <option value="M-PESA">M-PESA</option>
                                <option value="AIRTEL MONEY">AIRTEL MONEY</option>
                                <option value="KCB">KCB</option>
                                <option value="CO-OP">CO-OP</option>
                                <option value="EQUITY">EQUITY</option>
                            </select>
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Type</label>
                            <div class="grid grid-cols-1 gap-2">
                                <button onclick="window.setType('DEPOSIT', this)" class="type-btn p-3 text-left rounded-xl border-2 border-slate-900 bg-slate-900 text-white font-bold text-xs flex justify-between items-center">
                                    DEPOSIT (Cash In) <i data-lucide="check-circle-2" class="w-4 h-4 check-icon"></i>
                                </button>
                                <button onclick="window.setType('WITHDRAWAL', this)" class="type-btn p-3 text-left rounded-xl border-2 border-slate-100 bg-white text-slate-500 font-bold text-xs flex justify-between items-center">
                                    WITHDRAWAL (Cash Out) <i data-lucide="check-circle-2" class="w-4 h-4 opacity-0 check-icon"></i>
                                </button>
                                <button onclick="window.setType('FLOAT PURCHASE', this)" class="type-btn p-3 text-left rounded-xl border-2 border-slate-100 bg-white text-slate-500 font-bold text-xs flex justify-between items-center">
                                    FLOAT PURCHASE <i data-lucide="check-circle-2" class="w-4 h-4 opacity-0 check-icon"></i>
                                </button>
                            </div>
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-xs font-bold text-slate-500 uppercase ml-1">Amount (KES)</label>
                            <input id="amountInput" type="number" placeholder="0.00" class="w-full p-4 bg-slate-50 border-2 border-slate-100 rounded-2xl text-3xl font-mono font-bold focus:border-rose-500 outline-none" />
                        </div>

                        <button onclick="window.handleLogEntry()" class="w-full brand-gradient text-white py-5 rounded-2xl font-black text-xl shadow-lg flex items-center justify-center gap-3 transition-all hover:-translate-y-1">
                            Process Entry
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-7">
                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[750px]">
                    <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
                        <h3 class="font-bold flex items-center gap-2 text-slate-700 uppercase tracking-tight text-sm">
                            <i data-lucide="history" class="w-4 h-4 text-rose-500"></i> Audit Trail
                        </h3>
                        <span id="sessionCount" class="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded">0 ENTRIES</span>
                    </div>
                    
                    <div id="logList" class="flex-1 overflow-y-auto divide-y divide-slate-50">
                        <div class="p-20 text-center text-slate-300">
                            <i data-lucide="inbox" class="w-10 h-10 mx-auto mb-2 opacity-20"></i>
                            <p>Loading history...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your specific Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDnZ6a3p87xsXTbLxsb3mqLl9lbyLoa4kM",
            authDomain: "bellarosa-agency-control.firebaseapp.com",
            projectId: "bellarosa-agency-control",
            storageBucket: "bellarosa-agency-control.firebasestorage.app",
            messagingSenderId: "492744440948",
            appId: "1:492744440948:web:cf7799e1d03b7755292521",
            measurementId: "G-HTFVV1FPT2"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bellarosa-agency-v1';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.state = {
            user: null,
            staffName: "",
            selectedType: 'DEPOSIT',
            pendingTransaction: null,
            balances: {
                totalCashPool: 108454.00,
                agencyFloats: { 'M-PESA': 107098.74, 'AIRTEL MONEY': 2490.00, 'KCB': 11959.00, 'CO-OP': 19999.00, 'EQUITY': 0 }
            }
        };

        window.handleLogin = () => {
            const name = document.getElementById('staffNameInput').value.trim();
            if (!name) return;
            window.state.staffName = name;
            
            const gateway = document.getElementById('authGateway');
            const dashboard = document.getElementById('mainDashboard');
            gateway.classList.add('hidden-gateway');
            dashboard.classList.remove('opacity-0');
            dashboard.classList.add('opacity-100');
            document.getElementById('currentStaffDisplay').innerText = name;
            
            initCloud();
        };

        window.setType = (type, btn) => {
            window.state.selectedType = type;
            document.querySelectorAll('.type-btn').forEach(b => {
                b.className = 'type-btn p-3 text-left rounded-xl border-2 border-slate-100 bg-white text-slate-500 font-bold text-xs flex justify-between items-center';
                const icon = b.querySelector('.check-icon');
                if (icon) icon.classList.add('opacity-0');
            });
            btn.className = 'type-btn p-3 text-left rounded-xl border-2 border-slate-900 bg-slate-900 text-white font-bold text-xs flex justify-between items-center';
            const activeIcon = btn.querySelector('.check-icon');
            if (activeIcon) activeIcon.classList.remove('opacity-0');
        };

        window.handleLogEntry = () => {
            const amountInput = document.getElementById('amountInput');
            const amount = parseFloat(amountInput.value);
            const agency = document.getElementById('agencySelect').value;
            
            if (!amount || amount <= 0) return showMessage("Invalid amount", "error");

            let currentCash = window.state.balances.totalCashPool;
            let currentFloat = window.state.balances.agencyFloats[agency] || 0;
            
            let nextCash = currentCash;
            let nextFloat = currentFloat;

            if (window.state.selectedType === 'DEPOSIT') {
                if (currentFloat < amount) return showMessage(`Insufficient ${agency} Float`, "error");
                nextCash += amount;
                nextFloat -= amount;
            } else {
                if (currentCash < amount) return showMessage(`Insufficient Pooled Cash`, "error");
                nextCash -= amount;
                nextFloat += amount;
            }

            window.state.pendingTransaction = {
                agency,
                type: window.state.selectedType,
                amount,
                cashBefore: currentCash,
                cashAfter: nextCash,
                floatBefore: currentFloat,
                floatAfter: nextFloat,
                timestamp: Date.now(),
                date: new Date().toLocaleString(),
                staff: window.state.staffName
            };

            document.getElementById('confirmAgency').innerText = agency;
            document.getElementById('confirmType').innerText = window.state.selectedType;
            document.getElementById('confirmType').className = `text-[10px] font-black px-2 py-0.5 rounded ${window.state.selectedType === 'DEPOSIT' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`;
            document.getElementById('confirmAmount').innerText = amount.toLocaleString(undefined, { minimumFractionDigits: 2 });
            document.getElementById('confirmModal').classList.remove('hidden-overlay');
        };

        window.closeConfirmModal = () => {
            document.getElementById('confirmModal').classList.add('hidden-overlay');
            window.state.pendingTransaction = null;
        };

        window.commitTransaction = async () => {
            const entry = window.state.pendingTransaction;
            if (!entry) return;
            window.state.balances.totalCashPool = entry.cashAfter;
            window.state.balances.agencyFloats[entry.agency] = entry.floatAfter;
            document.getElementById('amountInput').value = '';
            closeConfirmModal();
            syncEntry(entry);
        };

        async function initCloud() {
            setSyncStatus('CONNECTING', 'amber');
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth failed:", e);
                setSyncStatus('ERROR', 'rose');
            }
        }

        onAuthStateChanged(auth, (u) => {
            if (u) {
                window.state.user = u;
                setSyncStatus('SYNCED', 'emerald');
                
                const balRef = doc(db, 'artifacts', appId, 'public', 'data', 'balances', 'current');
                onSnapshot(balRef, (s) => {
                    if (s.exists()) {
                        window.state.balances = s.data();
                        renderDashboard();
                    } else {
                        setDoc(balRef, window.state.balances);
                    }
                }, (err) => console.error("Balance sync error:", err));

                const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'logs');
                onSnapshot(logsRef, (s) => {
                    const logs = [];
                    s.forEach(d => logs.push(d.data()));
                    logs.sort((a,b) => b.timestamp - a.timestamp);
                    renderLogs(logs);
                }, (err) => console.error("Logs sync error:", err));
            }
        });

        async function syncEntry(payload) {
            if (!window.state.user) return;
            setSyncStatus('SAVING', 'amber');
            try {
                const balRef = doc(db, 'artifacts', appId, 'public', 'data', 'balances', 'current');
                await setDoc(balRef, window.state.balances);
                const logsRef = collection(db, 'artifacts', appId, 'public', 'data', 'logs');
                await addDoc(logsRef, payload);
                setSyncStatus('SYNCED', 'emerald');
                showMessage("Transaction recorded", "success");
            } catch (e) {
                console.error("Sync error:", e);
                setSyncStatus('ERROR', 'rose');
            }
        }

        function renderDashboard() {
            const cashEl = document.getElementById('totalCashDisplay');
            if (cashEl) cashEl.innerText = (window.state.balances.totalCashPool || 0).toLocaleString(undefined, { minimumFractionDigits: 2 });
            
            const grid = document.getElementById('floatGrid');
            if (!grid) return;
            grid.innerHTML = Object.entries(window.state.balances.agencyFloats).map(([name, val]) => `
                <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm animate-in transition-all">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1 flex justify-between">
                        ${name}
                        ${val < 5000 ? '<span class="text-rose-500">LOW</span>' : ''}
                    </p>
                    <p class="text-sm font-mono font-bold ${val < 5000 ? 'text-rose-500' : 'text-slate-700'}">
                        ${(val || 0).toLocaleString(undefined, { minimumFractionDigits: 2 })}
                    </p>
                    <div class="w-full bg-slate-100 h-1 mt-2 rounded-full overflow-hidden">
                        <div class="h-full ${val < 5000 ? 'bg-rose-500' : 'bg-slate-800'}" style="width: ${Math.min(100, (val/120000)*100)}%"></div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderLogs(logs) {
            const countEl = document.getElementById('sessionCount');
            if (countEl) countEl.innerText = `${logs.length} ENTRIES`;
            const list = document.getElementById('logList');
            if (!list) return;
            if (logs.length === 0) {
                list.innerHTML = `<div class="p-20 text-center text-slate-300 italic">No history found.</div>`;
                return;
            }
            list.innerHTML = logs.map(l => `
                <div class="p-5 border-l-4 ${l.type === 'DEPOSIT' ? 'border-l-emerald-400' : 'border-l-rose-400'} animate-in">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[10px] font-black text-slate-400 uppercase">${l.agency} • ${l.type}</span>
                        <span class="text-[9px] font-mono text-slate-300">${l.date}</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <p class="text-lg font-black font-mono">KES ${(l.amount || 0).toLocaleString()}</p>
                        <p class="text-[8px] text-slate-400">By: ${l.staff || 'System'}</p>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function setSyncStatus(text, color) {
            const el = document.getElementById('syncIndicator');
            if (!el) return;
            el.className = `flex items-center gap-1.5 px-2 py-1 rounded bg-${color}-50 text-${color}-600 text-[10px] font-bold`;
            el.innerHTML = `<i data-lucide="refresh-cw" class="w-3 h-3 ${text === 'SAVING' || text === 'CONNECTING' ? 'animate-spin' : ''} shadow-sm"></i> ${text}`;
            lucide.createIcons();
        }

        function showMessage(text, type) {
            const box = document.getElementById('messageBox');
            if (!box) return;
            box.innerText = text;
            box.className = `p-4 rounded-xl text-sm font-bold animate-in ${type === 'error' ? 'bg-rose-50 text-rose-700 border border-rose-100' : 'bg-emerald-50 text-emerald-700 border border-emerald-100'}`;
            box.classList.remove('hidden');
            if (type === 'success') setTimeout(() => box.classList.add('hidden'), 3000);
        }

        lucide.createIcons();
    </script>
</body>
</html>
